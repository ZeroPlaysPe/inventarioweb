<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi cuenta — InventarioPro</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* ===== Estilos específicos de esta página (look tipo Adobe) ===== */
    :root{
      --card-light:#ffffff; --text-dark:#0b0f1a; --muted-dark:#5a6478; --line:#e8ecf3;
    }
    body{ background:#0b1422; }
    .auth-shell{ min-height:100vh; display:grid; grid-template-columns: 1.1fr 1fr; }
    @media (max-width: 1000px){ .auth-shell{ grid-template-columns:1fr; } .auth-hero{ display:none; } }

    .auth-hero{
      position:relative; overflow:hidden;
      background:
        linear-gradient(0deg, rgba(0,0,0,.25), rgba(0,0,0,.25)),
        url('img/login-bg.jpg') center/cover no-repeat,
        radial-gradient(1000px 600px at 10% 10%, #2a1755 0%, transparent 60%),
        #0b0f1a;
      color:#fff;
    }
    .auth-hero-inner{ position:absolute; left:8%; bottom:10%; }
    .auth-logo{ font-weight:800; font-size:26px; display:flex; align-items:center; gap:10px; }
    .auth-logo::before{
      content:"◆"; display:inline-grid; place-items:center;
      width:28px;height:28px;border-radius:6px;background:#ffffff22;border:1px solid #ffffff44;
    }
    .auth-hero p{ margin:.4rem 0 0; opacity:.9 }

    .auth-panel{ display:grid; place-items:center; padding:34px 16px; }
    .auth-card{
      width:min(540px, 92%); background:var(--card-light); color:var(--text-dark);
      border-radius:14px; border:1px solid var(--line); box-shadow:0 12px 30px rgba(16,24,40,.08);
      padding:26px 26px 22px;
    }
    .auth-title{ margin:0 0 6px; font-size:28px; }
    .auth-sub{ margin:0 0 18px; color:var(--muted-dark); }
    .field{ display:grid; gap:6px; margin:12px 0; }
    .field label{ font-size:.92rem; color:var(--muted-dark); }
    .field input{
      font:inherit; padding:12px 12px; border-radius:10px; border:1px solid #d9dfeb; outline:none;
      background:#fff; color:#0b0f1a;
    }
    .field input:focus{ border-color:#6c8bff; box-shadow:0 0 0 3px #6c8bff22; }

    .btn{ display:inline-block; padding:12px 16px; border-radius:999px; border:1px solid transparent; cursor:pointer; }
    .btn-primary{ background:#1463ff; color:#fff; }
    .btn-primary:hover{ filter:brightness(1.05); }
    .btn-ghost{ background:#fff; border-color:#d9dfeb; color:#0b0f1a; }
    .btn-ghost:hover{ background:#f7f9fe; }

    .divider{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px; color:#7b879b; margin:16px 0; }
    .divider::before,.divider::after{ content:""; height:1px; background:#e6ebf5; }

    .socials{ display:grid; gap:10px; }
    .socials .btn{ justify-content:center; display:flex; align-items:center; gap:8px; font-weight:600; }
    .socials .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color:#5a6478; }
    .link{ color:#1463ff; text-decoration:none; font-weight:600; }
    .error{ color:#c62828; margin-top:8px; }
    .ok{ color:#1b5e20; margin-top:8px; }
  </style>
</head>
<body>
  <!-- LAYOUT login estilo Adobe + panel de perfil cuando ya está logeado -->
  <div class="auth-shell">
    <!-- Lado imagen / marca -->
    <aside class="auth-hero">
      <div class="auth-hero-inner">
        <div class="auth-logo">InventarioPro</div>
        <p>Inicia sesión o crea tu cuenta para descargar la app de inventario.</p>
      </div>
    </aside>

    <!-- Lado formulario -->
    <main class="auth-panel">
      <!-- Tarjeta de login/registro (se oculta si ya estás autenticado) -->
      <div class="auth-card" id="auth-card">
        <h1 class="auth-title" id="title">Inicio de sesión</h1>
        <p class="auth-sub">¿Eres nuevo? <a href="#" id="linkToggle" class="link">Crear una cuenta</a></p>

        <!-- Paso 1: email -->
        <div class="field">
          <label for="email">Dirección de correo electrónico</label>
          <input id="email" type="email" autocomplete="email" placeholder="tucorreo@dominio.com" required>
        </div>

        <!-- Paso 2: password (se muestra tras “Continuar”) -->
        <div class="field" id="rowPass" style="display:none">
          <label for="password">Contraseña</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="********" required>
        </div>

        <div class="row-actions" id="rowContinue">
          <button id="btnContinue" class="btn btn-primary">Continuar</button>
        </div>

        <div class="row-actions" id="rowSubmit" style="display:none">
          <button id="btnSubmit" class="btn btn-primary">Iniciar sesión</button>
          <button id="btnBack" class="btn btn-ghost" type="button">Volver</button>
        </div>

        <div id="msg" class="muted" style="min-height:22px; margin-top:8px;"></div>

        <div class="divider">o</div>

        <!-- Botones sociales deshabilitados en local -->
        <div class="socials">
          <button class="btn btn-ghost" type="button" disabled>Continuar con Google</button>
          <button class="btn btn-ghost" type="button" disabled>Continuar con Facebook</button>
          <button class="btn btn-ghost" type="button" disabled>Continuar con Apple</button>
        </div>

        <div style="margin-top:14px">
          <a class="muted" href="pricing.html">Volver a Precios</a>
        </div>
      </div>

      <!-- PANEL DE PERFIL (se muestra si ya estás autenticado) -->
      <div id="panel-perfil" class="card" style="display:none; padding:18px; margin-top:18px">
        <h3 style="margin:0 0 6px">Tu cuenta</h3>
        <p class="muted" id="panel-email"></p>
        <p class="muted" id="panel-status"></p>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px" id="panel-actions"></div>
      </div>
    </main>
  </div>

  <!-- ===== SCRIPT de la página ===== -->
  <script src="js/notify.js"></script>
  <script>
  // menú móvil
  const toggle=document.querySelector('.nav-toggle');
  const links=document.querySelector('.nav-links');
  toggle?.addEventListener('click',()=>links.classList.toggle('open'));

  // ===== Lógica login/registro + panel perfil + redirección =====
  let mode = 'login'; // 'login' | 'register'
  let step = 1;       // 1 = email, 2 = password
  const $ = (s)=>document.querySelector(s);

  const email   = $('#email');
  const pass    = $('#password');
  const rowPass = $('#rowPass');
  const rowContinue = $('#rowContinue');
  const rowSubmit   = $('#rowSubmit');
  const btnSubmit   = $('#btnSubmit');
  const msg   = $('#msg');

  // Lee returnTo de la URL
  const params = new URLSearchParams(location.search);
  const returnTo = params.get('returnTo');

  // Función para volver después de loguear
  function goBackAfterLogin(){
    if (returnTo && !/account\.html/i.test(returnTo)) {
      location.href = returnTo;
    } else {
      location.href = 'pricing.html';
    }
  }

  // Toggle entre login / register
  $('#linkToggle')?.addEventListener('click', (e)=>{
    e.preventDefault();
    mode = (mode === 'login') ? 'register' : 'login';
    $('#title').textContent = (mode === 'login') ? 'Inicio de sesión' : 'Crear cuenta';
    e.target.textContent    = (mode === 'login') ? 'Crear una cuenta' : 'Ya tengo cuenta';
    if (step === 2) btnSubmit.textContent = (mode === 'login') ? 'Iniciar sesión' : 'Crear cuenta';
  });

  // Paso 1 → Paso 2
  $('#btnContinue')?.addEventListener('click', ()=>{
    if (!email.value) { email.focus(); return; }
    step = 2;
    rowPass.style.display = '';
    rowContinue.style.display = 'none';
    rowSubmit.style.display = 'flex';
    btnSubmit.textContent = (mode === 'login') ? 'Iniciar sesión' : 'Crear cuenta';
    pass.focus();
  });

  // Volver al paso 1
  $('#btnBack')?.addEventListener('click', ()=>{
    step = 1;
    rowPass.style.display = 'none';
    rowContinue.style.display = 'flex';
    rowSubmit.style.display = 'none';
    msg.textContent = '';
  });

  // Enviar (login o register)
 btnSubmit?.addEventListener('click', async ()=>{
  if (!email.value || !pass.value) { msg.textContent = 'Completa los datos.'; msg.className='error'; return; }
  msg.textContent = 'Procesando...'; msg.className='muted';
  const url = (mode === 'login') ? '/api/login' : '/api/register';
  try{
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email: email.value.trim(), password: pass.value })
    });
    const j = await r.json();
    if (j.ok){
  setFlash('success', (mode === 'login') ? 'Sesión iniciada correctamente' : 'Registro exitoso. ¡Bienvenido!');
  goBackAfterLogin(); // ← vuelve a returnTo o a pricing
}else{
  msg.textContent = '';
  showToast(j.error || 'Ocurrió un error.', 'error', 4000);
}

  }catch(e){
    msg.textContent = 'No se pudo conectar con el servidor.';
    msg.className='error';
  }
});


  // Si ya llego autenticado y traía returnTo, vuelve de inmediato
  async function renderAccount(){
    try{
      const res = await fetch('/api/me'); const j = await res.json();
      const isAuth = !!j.user;

      const formsWrap = document.querySelector('.cards') || document.querySelector('#auth-card');
      const panel = document.getElementById('panel-perfil');
      const emailEl = document.getElementById('panel-email');
      const statusEl = document.getElementById('panel-status');
      const actionsEl = document.getElementById('panel-actions');

      if(isAuth && returnTo && !/account\.html/i.test(returnTo)){
        location.href = returnTo; // ya estás logeado: vuelve a donde estabas
        return;
      }

      if(!isAuth){
        formsWrap.style.display = '';
        panel.style.display = 'none';
        return;
      }

      // Mostrar panel si se abre /account.html a propósito
      formsWrap.style.display = 'none';
      panel.style.display = 'block';
      emailEl.textContent = `Usuario: ${j.user.email}`;
      statusEl.textContent = `Compra: ${j.user.purchased ? 'Activa ✅' : 'Pendiente ❌'}`;
      actionsEl.innerHTML = j.user.purchased
        ? `<a class="btn btn-primary" href="/download">Descargar aplicación</a>
           <button class="btn btn-ghost" id="btn-logout">Cerrar sesión</button>`
        : `<a class="btn btn-primary" href="pricing.html">Comprar</a>
           <button class="btn btn-ghost" id="btn-logout">Cerrar sesión</button>`;

      document.getElementById('btn-logout')?.addEventListener('click', async ()=>{
        await fetch('/api/logout',{method:'POST'});
        location.reload();
      });
    }catch(e){}
  }
  renderAccount();
</script>

<!-- Menú de usuario en el header -->
<script src="js/auth-ui.js"></script>
</body>
</html>
